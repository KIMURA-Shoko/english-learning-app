# CEFR A1/A2→B1 英語学習アプリ 要件定義（整理版）

- 改訂日: 2026-02-22（最新機能反映）
- 対象ディレクトリ: `E:\project\english-learning-app`
- 基本方針: 外部APIキーを使わず、事前生成した問題バンクを配信する

## 1. 目的
A1/A2学習者がB1到達を目指して、4択形式中心で継続学習できるWebアプリを提供する。

## 2. 対象レベル
- A1（導入）
- A2（基礎定着）
- B1（到達目標）

## 3. 問題設計
### 3.1 問題タイプ
- `fill_blank`（穴埋め）
- `response_choice`（応答選択）
- `short_reading`（短文読解）
- `sentence_build`（短文英作: 日本語に最も近い英文選択）

### 3.2 現在の問題数（実装済み）
- A1: 80問
- A2: 80問
- B1: 80問
- 合計: 240問
- 各レベル内で4タイプを均等配分（各20問）

### 3.3 問題データ生成方針
- 問題は `tools/generate-balanced-problems.ps1` で再生成可能
- 問題IDは `A1_G_0001` 形式
- `status` は `draft` / `published`

## 4. 学習機能要件
### 4.1 出題
- レベル選択で通常出題ができること
- 出題モードを選べること
  - 通常
  - 誤答のみ（全レベル横断）

### 4.2 回答と表示
- 回答後に正誤を表示すること
- 日本語解説を表示すること
- 選択肢の表示順は問題ごとにシャッフルすること
- 正解ラベル（A/B/C/D）はシャッフル後の表示位置に一致すること

### 4.3 選択肢の日本語訳表示
- 回答後、選択肢が英語文の場合に限り、全選択肢の日本語訳を表示すること
- 日本語を含む選択肢は訳表示対象外とすること
- 翻訳ロジックは以下の2段階とすること
  - 完全一致辞書（定型選択肢）
  - 単語辞書ベースのフォールバック（参考訳）

### 4.4 誤答復習
- 不正解時に誤答ストックへ自動追加すること
- 問題単位で誤答ログを保持すること
  - 誤答回数
  - 最終誤答日時
  - 誤答履歴
- 誤答ストック中の問題は3回連続正解で自動解除すること
- 手動削除UIは設けない（誤答ストック削除ボタンは非搭載）

### 4.5 誤答履歴エクスポート
- 誤答履歴をJSONとしてダウンロードできること
- エクスポート内容:
  - `exported_at`
  - `wrong_problem_ids`
  - `wrong_logs`

## 5. 品質要件
### 5.1 構造品質
- 必須項目欠落、ID不整合、選択肢数不正、answer範囲外をエラーとする
- 重複問題文（完全一致）をエラーとする
- 類似問題（しきい値超え）を警告として検出する

### 5.2 言語品質
- `fill_blank` では正答埋め込み後の正解文が英語として不自然でないこと
- 不自然判定（連続同語、目的語欠落パターンなど）を品質チェックで検出する
- 正答と解説の整合が取れていること

### 5.3 品質チェック運用
- 使用スクリプト: `tools/quality-check.ps1`
- 問題更新時は再生成後に必ず品質チェックを実行する

## 6. データ要件
### 6.1 問題データ（JSON）
- 主項目:  
`problem_id, cefr_level, skill_type, question_type, question_text, choices, answer, explanation_ja, key_phrase, status, created_at, source`

### 6.2 スキーマ
- `schema/problem.schema.json`
- `question_type` は以下を許可:
  - `fill_blank`
  - `response_choice`
  - `short_reading`
  - `sentence_build`

### 6.3 ローカル保存
- `cefr_wrong_problem_ids_v1`: 誤答ストックID配列
- `cefr_wrong_logs_v1`: 問題別誤答ログ
  - `wrong_count`
  - `last_wrong_at`
  - `wrong_history`
  - `recovery_correct_streak`

## 7. 分析要件
- エクスポートJSONを元に弱点分析レポートを生成できること
- 使用スクリプト: `tools/analyze-wrong-history.ps1`
- レポート出力: `reports/weakness-report.md`
- 最低限の集計:
  - CEFRレベル別
  - 問題タイプ別
  - スキルタイプ別
  - 誤答回数上位問題
  - 直近誤答

## 8. 非機能要件
- 静的配信（GitHub Pages）で動作すること
- PC / iPhone Safari で利用可能であること
- 主要UI操作はモバイル幅でも破綻しないこと
- APIキーをクライアントに保持しないこと

## 9. 受け入れ基準
- 問題総数が240問であること（A1/A2/B1 各80）
- 各レベルで4タイプが各20問であること
- 品質チェック結果が `Errors: 0` であること
- 通常出題・誤答のみ出題が動作すること
- 回答後の選択肢和訳表示（英語選択肢時）が動作すること
- 誤答ログ表示と3回連続正解解除が動作すること
- 誤答履歴JSONのエクスポートが動作すること
- 弱点分析スクリプトでレポート出力できること

## 10. 運用手順（要約）
1. `tools/generate-balanced-problems.ps1` で問題再生成
2. `tools/quality-check.ps1` で品質検証
3. ローカル動作確認（`python -m http.server 8000`）
4. 必要に応じて誤答履歴をエクスポート
5. `tools/analyze-wrong-history.ps1` で弱点レポート生成
6. Gitコミット・GitHub push・Pages確認

## 11. 今後の拡張候補
- 翻訳辞書の継続拡充（定型文・語彙カバレッジ向上）
- 難易度別の誤答分析ダッシュボード
- セッション履歴・連続学習日数の可視化
- 問題レビュー用の管理画面強化
